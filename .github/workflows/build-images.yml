name: Build & Push Docker Images + Bump GitOps

on:
  workflow_dispatch:
  push:
    branches:
      - staging
      - dev

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  REPO_PATH: ${{ github.repository }}                 # owner/repo
  IMAGE_TAG: ${{ github.sha }}                        # immutable tag used in GitOps bump

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      auth: ${{ steps.filter.outputs.auth }}
      store: ${{ steps.filter.outputs.store }}
      registry: ${{ steps.filter.outputs.registry }}
      migrations: ${{ steps.filter.outputs.migrations }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ github.event.before }}
          ref: ${{ github.sha }}
          filters: |
            backend:
              - 'backend/**'
            auth:
              - 'auth/**'
            store:
              - 'services/store-deployer/**'
            registry:
              - 'services/template-registry/**'
            migrations:
              - 'backend/migrations.Dockerfile'

  build-backend:
    needs: changes
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4

      - name: Skip note (no backend changes)
        if: needs.changes.outputs.backend != 'true'
        run: echo "No changes in backend/**. Skipping backend image build."

      - name: Log in to GitHub Container Registry
        if: needs.changes.outputs.backend == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        if: needs.changes.outputs.backend == 'true'
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest

      - name: Build & Push backend
        if: needs.changes.outputs.backend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/backend:latest
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/backend:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-auth-handler:
    needs: changes
    if: needs.changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest
      - name: Build & Push auth-handler
        uses: docker/build-push-action@v5
        with:
          context: ./auth/authentication-handler
          file: ./auth/authentication-handler/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/auth-handler:latest
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/auth-handler:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-store-deployer:
    needs: changes
    if: needs.changes.outputs.store == 'true'
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest
      - name: Build & Push store-deployer
        uses: docker/build-push-action@v5
        with:
          context: ./services/store-deployer
          file: ./services/store-deployer/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/store-deployer:latest
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/store-deployer:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-template-registry:
    needs: changes
    if: needs.changes.outputs.registry == 'true'
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest
      - name: Build & Push template-registry
        uses: docker/build-push-action@v5
        with:
          context: ./services/template-registry
          file: ./services/template-registry/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/template-registry:latest
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/template-registry:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-migrations:
    needs: changes
    if: needs.changes.outputs.migrations == 'true'
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
        with:
          driver-opts: image=moby/buildkit:latest
      - name: Build & Push migrations
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/migrations.Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/backend-migrations:latest
            ${{ env.REGISTRY }}/${{ env.REPO_PATH }}/backend-migrations:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  gitops-bump:
    name: Update kustomization.yaml with new tag & commit once
    runs-on: ubuntu-latest
    needs:
      - build-backend
      - build-auth-handler
      - build-store-deployer
      - build-template-registry
      - build-migrations
    permissions:
      contents: write         # needed to push back to the repo
    steps:
      # --- Same-repo GitOps (default) ---
      - name: Checkout repo (manifests live here)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # --- Separate GitOps repo (optional) ---
      # - name: Checkout GitOps repo
      #   if: env.GITOPS_REPO != ''
      #   uses: actions/checkout@v4
      #   with:
      #     repository: ${{ env.GITOPS_REPO }}            # e.g. your-org/your-gitops-repo
      #     token: ${{ secrets.GITOPS_PUSH_TOKEN }}        # classic PAT with repo write
      #     ref: ${{ env.GITOPS_BRANCH || 'main' }}
      #     fetch-depth: 0

      - name: Install kustomize manually
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Bump images in production overlays
        working-directory: deploy/overlays/production
        run: |
          set -euo pipefail
          echo "Using IMAGE_TAG=${IMAGE_TAG}"
          # Map base image names -> canonical GHCR newName and tag
          kustomize edit set image naytife/backend=${REGISTRY}/${REPO_PATH}/backend:${IMAGE_TAG}
          kustomize edit set image naytife/auth-handler=${REGISTRY}/${REPO_PATH}/auth-handler:${IMAGE_TAG}
          kustomize edit set image template-registry=${REGISTRY}/${REPO_PATH}/template-registry:${IMAGE_TAG}
          kustomize edit set image docker.io/library/store-deployer=${REGISTRY}/${REPO_PATH}/store-deployer:${IMAGE_TAG}

      - name: Show diff
        run: |
          git status
          git --no-pager diff || true

      - name: Commit & push (single commit)
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No manifest changes to commit."
            exit 0
          fi
          git config user.name  "gitops-bot"
          git config user.email "gitops-bot@users.noreply.github.com"
          git add deploy/overlays/production/kustomization.yaml
          git commit -m "gitops: bump production images to ${IMAGE_TAG} [skip-ci]"
          git push