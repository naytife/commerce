name: Deploy Oathkeeper to Kubernetes

on:
  push:
    branches:
      - dev
    paths:
      - 'auth/oathkeeper/access-rules.json'
      - 'auth/oathkeeper/oathkeeper-values.yaml'
      - '.github/workflows/deploy-oathkeeper.yml'

jobs:
  deploy:
    environment:
      name: stage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install and Authenticate doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Authenticate with DigitalOcean Kubernetes
        run: |
          doctl kubernetes cluster kubeconfig save --expiry-seconds 600 ${{ secrets.CLUSTER_NAME }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Add Ory Helm Repo
        run: |
          helm repo add ory https://k8s.ory.sh/helm/charts
          helm repo update

      - name: Deploy Oathkeeper with Helm
        run: |
            helm upgrade --install oathkeeper ory/oathkeeper \
              --namespace auth \
              --create-namespace \
              -f auth/oathkeeper/oathkeeper-values.yaml \
              --set oathkeeper.config.authenticators.oauth2_introspection.config.pre_authorization.client_id=${{ secrets.HYDRA_OAUTH2_CLIENT_ID }} \
              --set oathkeeper.config.authenticators.oauth2_introspection.config.pre_authorization.client_secret=${{ secrets.HYDRA_OAUTH2_CLIENT_SECRET }} \
              --set-file oathkeeper.accessRules=./auth/oathkeeper/access-rules.json